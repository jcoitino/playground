<!DOCTYPE html>
<html>

<head>
	<title>MobX + React Playground</title>
	<link rel="stylesheet" type="text/css" href="index.css">
	<script src="node_modules/monaco-editor/min/vs/loader.js"></script>
	<script>
		// FIX: Monaco overrides NODE "require" with his own AMD based
		let amd = require; require = amd.nodeRequire;
	</script>
</head>

<body>
	<div id="commands">
		<button id="edtcmd" class="hidden">Edit</button>
		<button id="runcmd" class="hidden">Run</button>
		<button id="cmpcmd">Compile</button>
		<button id="xplcmd">Sample</button>
	</div>
	<div id="source"></div>
	<div id="target"></div>
	<div id="output" class="hidden"></div>
	<script>
		let source = document.getElementById('source');
		let target = document.getElementById('target');
		let output = document.getElementById('output');
		let edtcmd = document.getElementById('edtcmd');
		let runcmd = document.getElementById('runcmd');
		let cmpcmd = document.getElementById('cmpcmd');
		let xplcmd = document.getElementById('xplcmd');

		let { join, resolve } = require('path');
		let { existsSync, readFileSync } = require('fs');
		let read = (p) => readFileSync(join(__dirname, p)).toString();

		self.module = undefined;
		self.process.browser = true;
		let baseUrl = 'file:///' + resolve(join(__dirname, "node_modules/monaco-editor/min")).replace(/\\/g, '/');
		amd.config({ baseUrl });
		amd(['vs/editor/editor.main', 'vs/language/typescript/lib/typescriptServices'], (editor, ts) => {
			let l0 = `declare module "tslib"      {\n${read("node_modules\\tslib\\tslib.d.ts")}\n}`;
			let l1 = `declare module "react"      {\n${read("node_modules\\@types\\react\\index.d.ts")}\n}`;
			let l2 = `declare module "react-dom"  {\n${read("node_modules\\@types\\react-dom\\index.d.ts")}\n}`;
			let l3 = `declare module "mobx"       {\n${read("node_modules\\mobx\\lib\\mobx.d.ts")}\n}`;
			let l4 = `declare module "mobx-react" {\n${read("node_modules\\mobx-react\\index.d.ts")}\n}`;
			monaco.languages.typescript.typescriptDefaults.addExtraLib(l0, "tslib.d.ts");
			monaco.languages.typescript.typescriptDefaults.addExtraLib(l1, "react.d.ts");
			monaco.languages.typescript.typescriptDefaults.addExtraLib(l2, "react-dom.d.ts");
			monaco.languages.typescript.typescriptDefaults.addExtraLib(l3, "mobx.d.ts");
			monaco.languages.typescript.typescriptDefaults.addExtraLib(l4, "mobx-react.d.ts");

			let co = {
				target: monaco.languages.typescript.ScriptTarget.ES2017,
				module: monaco.languages.typescript.ModuleKind.CommonJS,
				moduleResolution: monaco.languages.typescript.ModuleResolutionKind.NodeJs,
				importHelpers: true,
				experimentalDecorators: true,
				strictNullChecks: true,
				skipLibCheck: true,
				allowNonTsExtensions: true,
				suppressOutputPathCheck: true,
			};
			monaco.languages.typescript.typescriptDefaults.setCompilerOptions(co);

			let eo = {
				theme: "vs-dark",
				folding: true,
				autoIndent: true,
				formatOnType: true,
				formatOnPaste: true,
				mouseWheelZoom: true,
				scrollBeyondLastLine: false,
				minimap: { enabled: false },
				value: "",
			};
			let se = monaco.editor.create(source, Object.assign({ language: "typescript" }, eo));
			let te = monaco.editor.create(target, Object.assign({ language: "javascript" }, eo));

			window.addEventListener("resize", () => {
				se.layout();
				te.layout();
			});
			xplcmd.addEventListener("click", () => {
				se.setValue(read("sample.tsx"));
				te.setValue(read("sample.jsx"));
			});
			cmpcmd.addEventListener("click", () => {
				te.setValue(transpile(se.getValue(), co));
				output.classList = ["hidden"];
				cmpcmd.classList = ["hidden"];
				xplcmd.classList = ["hidden"];
				edtcmd.classList = [];
				runcmd.classList = [];
			});
			runcmd.addEventListener("click", () => {
				output.classList = [];
				edtcmd.classList = [];
				cmpcmd.classList = ["hidden"];
				runcmd.classList = ["hidden"];
				eval(`(function() {\nlet exports = {};\n${te.getValue()}})()`);
			});
			edtcmd.addEventListener("click", () => {
				output.classList = ["hidden"];
				edtcmd.classList = ["hidden"];
				runcmd.classList = ["hidden"];
				cmpcmd.classList = [];
				xplcmd.classList = [];
			});

			function transpile(input, options) {
				let outputText;
				let inputFileName = options && options.jsx ? "module.tsx" : "module.ts";
				let sourceFile = ts.createSourceFile(inputFileName, input, options.target || ts.ScriptTarget.ES5);
				let program = ts.createProgram([inputFileName], options, {
					getSourceFile: (fileName) => fileName.indexOf("module") === 0 ? sourceFile : undefined,
					writeFile: (_, text) => outputText = text,
					getDefaultLibFileName: () => "lib.d.ts",
					useCaseSensitiveFileNames: () => false,
					getCanonicalFileName: (fileName) => fileName,
					getCurrentDirectory: () => "",
					getNewLine: () => "\r\n",
					fileExists: (fileName) => fileName === inputFileName || existsSync(join(__dirname, fileName)),
					readFile: (fileName) => read(fileName),
					directoryExists: (fileName) => existsSync(join(__dirname, fileName)),
					getDirectories: (fileName) => [],
				});
				program.emit(); if (outputText === undefined) { throw new Error("Output generation failed"); }
				return outputText;
			}
		});
	</script>
</body>

</html>