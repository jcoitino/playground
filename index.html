<!DOCTYPE html>
<html>

<head>
	<title>MobX + React Playground</title>
	<link rel="stylesheet" type="text/css" href="index.css">
	<script src="node_modules/monaco-editor/min/vs/loader.js"></script>
	<script>
		let amd = require; global.require = amd.nodeRequire;
	</script>
</head>

<body>
	<div id="commands">
		<button id="edtcmd" class="hidden">Edit</button>
		<button id="runcmd" class="hidden">Run</button>
		<button id="cmpcmd">Compile</button>
		<button id="xplcmd">Sample</button>
	</div>
	<div id="source"></div>
	<div id="target"></div>
	<div id="output" class="hidden"></div>
	<style>
		#source {
			position: absolute;
			left: 20px;
			width: calc(50% - 30px);
			height: calc(100% - 50px);
			background: white;
			overflow: hidden;
		}

		#target {
			position: absolute;
			left: calc(50% + 10px);
			width: calc(50% - 30px);
			height: calc(100% - 50px);
			background: silver;
			overflow: hidden;
		}

		#output {
			position: absolute;
			left: 20px;
			width: calc(50% - 30px);
			height: calc(100% - 50px);
			background: white;
			overflow: hidden;
		}

		#commands {
			display: flex;
			align-content: center;
			align-items: center;
			height: 30px;
		}

		#commands>button {
			margin-left: 20px;
		}

		.hidden {
			display: none;
		}
	</style>
	<script>
		self.module = undefined;
		self.process.browser = true;
		let { join, resolve } = require('path');
		let { existsSync, readFileSync } = require('fs');
		let read = (p) => readFileSync(join(__dirname, p)).toString();
		let lib0 = `declare module "tslib" 		{\n${read("node_modules\\tslib\\tslib.d.ts")}\n}`;
		let lib1 = `declare module "react" 		{\n${read("node_modules\\@types\\react\\index.d.ts")}\n}`;
		let lib2 = `declare module "react-dom" 	{\n${read("node_modules\\@types\\react-dom\\index.d.ts")}\n}`;
		let lib3 = `declare module "mobx" 		{\n${read("node_modules\\mobx\\lib\\mobx.d.ts")}\n}`;
		let lib4 = `declare module "mobx-react" {\n${read("node_modules\\mobx-react\\index.d.ts")}\n}`;
		let source = document.getElementById('source');
		let target = document.getElementById('target');
		let output = document.getElementById('output');
		let edtcmd = document.getElementById('edtcmd');
		let runcmd = document.getElementById('runcmd');
		let cmpcmd = document.getElementById('cmpcmd');
		let xplcmd = document.getElementById('xplcmd');
		let sc = `// sample code
import {createElement} 					from "react";
import {render} 						from "react-dom";
import {action, observable, useStrict}	from "mobx";
import {observer} 						from "mobx-react";

class BoxModel {
    @observable id: string;
    @observable x: number;
    @observable y: number;
    @observable w: number;
    @observable h: number;
    @observable c: string;
    constructor(id: string, x: number, y: number, w: number, h: number, c: string) {
        this.id = id;
        this.x = x
        this.y = y;
        this.w = w;
        this.h = h;
        this.c = c;
    }
    @action changeColor(color)  { this.c = color; }
    @action moveBy(x, y)        { this.x += x; this.y += y; }
    @action resizeBy(w, h)      { this.w *= w; this.h *= h; }
}

class BoxesModel {
    @observable boxes: BoxModel[];
    constructor(boxes: BoxModel[]) {
        this.boxes = boxes;
    }
    @action addBox(box: BoxModel) {
        this.boxes.push(box);
     }
}

let model = new BoxesModel(
    [
        new BoxModel("#1", 100, 100, 100, 100, "red"),
        new BoxModel("#2", 100, 300, 100, 100, "green"),
        new BoxModel("#3", 300, 100, 100, 100, "blue"),
    ]
);

let Box   = observer((props: { model: BoxModel }) => {
    const o = props.model;
    const p = { style: { position: "absolute", background: o.c, top: o.y, left: o.x, width: o.w, height: o.h } };
    return createElement("div", p);
});
let Boxes = observer((props: { model: BoxesModel }) => {
    let b = props.model.boxes;
    let c = b.map(model => createElement(Box, { key: model.id, model }));
    return createElement("div", null, c);
});

let boxes = createElement(Boxes, { model }, null);
let output = document.getElementById("output");
render(boxes, output);

debugger;
model.boxes[0].changeColor("yellow");
for (let s of [100, 100]) { 
    model.boxes[0].moveBy(s, s); 
}
model.boxes[1].resizeBy(2, 1);
model.boxes[2].resizeBy(1, 2);
model.addBox(new BoxModel("#4", 100, 100, 200, 200, "maroon"));
`
		let se = null;
		let te = null;
		let ts = null;
		let co = null;
		let baseUrl = 'file:///' + resolve(join(__dirname, "node_modules/monaco-editor/min")).replace(/\\/g, '/');
		amd.config({ baseUrl });
		amd(['vs/editor/editor.main', 'vs/language/typescript/lib/typescriptServices'], (a, b) => {
			monaco.languages.typescript.typescriptDefaults.addExtraLib(lib0, "tslib.d.ts");
			monaco.languages.typescript.typescriptDefaults.addExtraLib(lib1, "react.d.ts");
			monaco.languages.typescript.typescriptDefaults.addExtraLib(lib2, "react-dom.d.ts");
			monaco.languages.typescript.typescriptDefaults.addExtraLib(lib3, "mobx.d.ts");
			monaco.languages.typescript.typescriptDefaults.addExtraLib(lib4, "mobx-react.d.ts");
			co = {
				target: monaco.languages.typescript.ScriptTarget.ES2017,
				module: monaco.languages.typescript.ModuleKind.CommonJS,
				moduleResolution: monaco.languages.typescript.ModuleResolutionKind.NodeJs,
				experimentalDecorators: true,
				allowNonTsExtensions: true,
			}
			monaco.languages.typescript.typescriptDefaults.setCompilerOptions(co);
			se = monaco.editor.create(source, { theme: "vs-dark", language: "typescript", formatOnType: true, value: "" });
			te = monaco.editor.create(target, { theme: "vs-dark", language: "javascript" });
			ts = b;
		});
		window.addEventListener("resize", () => {
			if (se) { se.layout(); }
			if (te) { te.layout(); }
		});
		xplcmd.addEventListener("click", () => {
			se.setValue(sc);
		});
		cmpcmd.addEventListener("click", () => {
			let s = se.getValue();
			let t = transpile(s, { module: ts.ModuleKind.CommonJS, target: ts.ScriptTarget.ES2017, noLib: true, noResolve: true, suppressOutputPathCheck: true });
			te.setValue(t);
			output.classList = ["hidden"];
			cmpcmd.classList = ["hidden"];
			xplcmd.classList = ["hidden"];
			edtcmd.classList = [];
			runcmd.classList = [];
		});
		runcmd.addEventListener("click", () => {
			output.classList = [];
			edtcmd.classList = [];
			cmpcmd.classList = ["hidden"];
			runcmd.classList = ["hidden"];
			let s = te.getValue();
			eval(`(function() { let exports = {};\n${s} })()`);
		});
		edtcmd.addEventListener("click", () => {
			output.classList = ["hidden"];
			edtcmd.classList = ["hidden"];
			runcmd.classList = ["hidden"];
			cmpcmd.classList = [];
			xplcmd.classList = [];
		});
		function transpile(input, options) {
			let outputText;
			let inputFileName = options && options.jsx ? "module.tsx" : "module.ts";
			let sourceFile = ts.createSourceFile(inputFileName, input, options.target || ts.ScriptTarget.ES5);
			let program = ts.createProgram([inputFileName], options, {
				getSourceFile: function (fileName) { return fileName.indexOf("module") === 0 ? sourceFile : undefined; },
				writeFile: function (_name, text) { outputText = text; },
				getDefaultLibFileName: function () { return "lib.d.ts"; },
				useCaseSensitiveFileNames: function () { return false; },
				getCanonicalFileName: function (fileName) { return fileName; },
				getCurrentDirectory: function () { return ""; },
				getNewLine: function () { return "\r\n"; },
				fileExists: function (fileName) { return fileName === inputFileName || existsSync(join(__dirname, fileName)); },
				readFile: function (fileName) { return read(fileName); },
				directoryExists: function (fileName) { return existsSync(join(__dirname, fileName)); },
				getDirectories: function (fileName) { return []; }
			});
			program.emit(); if (outputText === undefined) { throw new Error("Output generation failed"); }
			return outputText;
		}
	</script>
</body>

</html>